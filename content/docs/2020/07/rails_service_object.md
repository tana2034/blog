---
title: "[rails]Service Objectの導入と実装"
date: 2020-07-15T22:02:50+09:00
---

# [rails]Service Objectの導入と実装

Railsで実装を追加していてServiceというのを使っているのを発見したので、これについて調査

## 導入する目的はなにか

ActiveRecordモデルが肥大化して分割したい場合に使用する。
ModelがFatになった場合、たいてい「[単一責任の原則](http://objectclub.jp/technicaldoc/object-orientation/principle/principle03)」に反している場合が多いと思われる。（単一責任の原則とは、「1つのクラスは1つの責務を持つ」考え方で、「クラスに変更が起こる理由は、一つであるべき」とされている。変更に複数の理由があるような場合、それは複数のクラスに分割したほうが、責務が凝集する、この辺はよくわかっていないので、あとでやる）

## どういった場合に導入するのがよいか

- アクションが複雑になる場合
- アクションが複数のモデルに渡って動作する場合
- アクションから外部サービスとやり取りする場合
- アクションが背後のモデルの中核をなすものでない場合
  - 一定期間ごとに古くなったデータを消去する
- アクションの実行方法が多岐に渡る場合

## どうやって導入するか

- [Railsにおけるサービスクラスのオリジナルルール](https://qiita.com/chrischris0801/items/58a12d17a440b842db02)

参考にした記事でも、他の記事でも、ルールの通りに実装することが推奨される。
これは、このあとに示すようにアンチパターンに

### 命名規則を1つに定める

- Service ObjectのClass命名ルールを定める。
  - `or`をつける (例　)
  - 動詞+名詞+`Service`をつける

### 直接インスタンス化しない

基本的には呼び出し方法が固定なので、インスタンスを作ることに意義がない

```ruby
    def self.call(*args)
      new(*args).call
    end
```

この挙動をモジュール化して各Serviceに読み込ませるとより処理が統一できてよい

### 呼び出し方法を1つに定める

- `call`, `run`, `perform`, `execute`など、いずれかに呼びだし方法を統一する
 
### 責務を一つに絞り込む

- 呼び出し方法が統一されているので、絞り込まざるを得ない
- 例えば、DeleteやCreateなどいろんな動作をさせたい場合は、`ManageUser`のような汎用的な名前でなく、`DeleteUser`や`CreateUser`などの複数のServiceに分けたほうがよい

### コンストラクタを複雑にしない

- 引数をserviceのインスタンス変数に保存する、など、限定的な動作に留める

```ruby
  def initialize(user_id:)
    @user_id = user_id
  end
```

### `call`メソッドの引数をシンプルにする

### 結果はステートリーダー経由で返す

callメソッドがServiceObject自身を返すようにするとより柔軟になる

### `call`メソッドの可読性を下げないようにする

- callメソッドはService Objectの中心となるメソッドのため、できるだけ読みやすく保つ

## アンチパターンを考える

- [Service Objectがアンチパターンである理由とよりよい代替手段（翻訳）](https://techracho.bpsinc.jp/hachi8833/2018_04_16/55130)
  - Service Objectを縛るルールが特にないので、メソッドが複雑化しやすい

- [俺が悪かった。素直に間違いを認めるから、もうサービスクラスとか作るのは止めてくれ](https://qiita.com/joker1007/items/25de535cd8bb2857a685)


無秩序になると、ただただロジックが蓄積していくだけの場所になりかねず、そうするとController, Modelとの差別化ができず、ソースコードを追うことが辛くなる。
これはModelに書くべきことじゃない、とわかっているものを、ルールにそってService Objectとして扱うのがよいと思う。

## 感想

- Service Objectは、Modelの責務外と思われるロジックを書くのに使うと良い
- その際には、各Service Objectには単一の責務だけを追わせるようにし、ルールに従うことで過剰なロジックを背負わないように気をつける
- Service Objectが肥大すると可読性が落ちるのはModelの肥大化と一緒、Classの責務について考えつつ実装をすすめる


## おまけ　Service Objectはどこからきたのか

使ってみた感想〜みたいな例を除くと、記事となっているのはこの辺り

https://techracho.bpsinc.jp/hachi8833/2017_10_16/46482
https://techracho.bpsinc.jp/hachi8833/2013_11_19/14738
https://techracho.bpsinc.jp/hachi8833/2017_12_07/48363

もしかしたらDDDにも`Service層`という概念があるので、そのへんからきてるのかもしれない
